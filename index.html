<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LVN HESI Practice</title>
<link rel="manifest" href="./manifest.json">
<style>
:root{
  --bg:#0b0f14; --panel:#111827; --panel2:#0f172a;
  --text:#e5e7eb; --muted:#9ca3af; --border:rgba(255,255,255,0.10);
  --radius:16px; --font: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  --accent:#7c3aed; --accentSoft: rgba(124,58,237,0.18); --accentSoft2: rgba(124,58,237,0.10);
  --ok:#22c55e; --bad:#ef4444; --focus: 0 0 0 3px var(--accentSoft);
}
body[data-theme="dark"]{ --bg:#0b0f14; --panel:#111827; --panel2:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --border:rgba(255,255,255,0.10); }
body[data-theme="light"]{ --bg:#f6f7fb; --panel:#ffffff; --panel2:#ffffff; --text:#111827; --muted:#4b5563; --border:rgba(17,24,39,0.12); --accentSoft: rgba(124,58,237,0.14); --accentSoft2: rgba(124,58,237,0.08); }
body[data-theme="clinical"]{ --bg:#07121a; --panel:#0b1e2a; --panel2:#08202a; --text:#e6f6ff; --muted:#8fb0c3; --border:rgba(230,246,255,0.14); }
body[data-accent="purple"]{ --accent:#7c3aed; --accentSoft: rgba(124,58,237,0.18); --accentSoft2: rgba(124,58,237,0.10); }
body[data-accent="teal"]{ --accent:#06b6d4; --accentSoft: rgba(6,182,212,0.18); --accentSoft2: rgba(6,182,212,0.10); }
body[data-accent="rose"]{ --accent:#f43f5e; --accentSoft: rgba(244,63,94,0.18); --accentSoft2: rgba(244,63,94,0.10); }
body[data-accent="amber"]{ --accent:#f59e0b; --accentSoft: rgba(245,158,11,0.20); --accentSoft2: rgba(245,158,11,0.10); }
*{ box-sizing:border-box; }
body{
  margin:0; font-family:var(--font);
  background:
    radial-gradient(900px 600px at 10% 0%, var(--accentSoft2), transparent 55%),
    radial-gradient(700px 500px at 100% 10%, rgba(34,197,94,0.06), transparent 55%),
    var(--bg);
  color:var(--text);
}
.wrap{ max-width:1120px; margin:0 auto; padding:18px; }
h1{ font-size:26px; margin:0 0 6px; letter-spacing:0.2px; }
.sub{ color:var(--muted); margin:0 0 16px; }
.grid{ display:grid; grid-template-columns: 1.25fr 0.75fr; gap:14px; }
@media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }
.card{
  background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent), var(--panel);
  border:1px solid var(--border); border-radius:var(--radius); padding:14px;
  box-shadow: 0 16px 40px rgba(0,0,0,0.22);
  position:relative; overflow:hidden;
}
.card::before{
  content:""; position:absolute; inset:-2px;
  background: radial-gradient(500px 200px at 30% 0%, var(--accentSoft), transparent 60%);
  opacity:0.45; pointer-events:none;
}
.card > *{ position:relative; }
.row{ display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; }
label{ font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }
select{
  background: rgba(0,0,0,0.10); color:var(--text);
  border:1px solid var(--border); border-radius:12px; padding:10px 10px;
  min-width:160px; outline:none;
}
select:focus{ box-shadow: var(--focus); border-color: var(--accent); }
.btns{ margin-left:auto; display:flex; gap:10px; }
button{
  background: linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.02)), var(--accent);
  color:white; border:0; border-radius:12px; padding:10px 14px; font-weight:800;
  cursor:pointer; box-shadow: 0 10px 22px rgba(0,0,0,0.22);
}
button:hover{ filter:brightness(1.05); }
button:focus{ outline:none; box-shadow: var(--focus); }
button.secondary{ background: rgba(0,0,0,0.12); border:1px solid var(--border); color:var(--text); box-shadow:none; }
button.danger{ background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.02)), var(--bad); }
.pill{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 10px; border:1px solid var(--border); border-radius:999px;
  color:var(--muted); background: rgba(0,0,0,0.10);
}
.pill b{ color:var(--text); }
.tag{ font-size:12px; color:var(--text); background: var(--accentSoft); border:1px solid rgba(255,255,255,0.06);
  padding:6px 10px; border-radius:999px; }
.metaLine{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
.qstem{ font-size:18px; line-height:1.35; margin:0 0 10px; }
.choices{ display:grid; gap:8px; }
.choice{
  border:1px solid var(--border); border-radius:12px; padding:10px; cursor:pointer;
  background: rgba(0,0,0,0.08); transition: transform 0.04s ease, border-color 0.12s ease;
}
.choice:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,0.18); }
.choice.sel{ box-shadow: var(--focus); border-color: var(--accent); }
.choice.correct{ border-color: rgba(34,197,94,0.7); box-shadow: 0 0 0 3px rgba(34,197,94,0.18); }
.choice.wrong{ border-color: rgba(239,68,68,0.7); box-shadow: 0 0 0 3px rgba(239,68,68,0.18); }
.tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
.tab{ padding:8px 10px; border-radius:10px; border:1px solid var(--border); color:var(--muted); cursor:pointer; background: rgba(0,0,0,0.08); }
.tab.active{ color:var(--text); border-color: var(--accent); box-shadow: var(--focus); background: var(--accentSoft2); }
pre{ white-space:pre-wrap; word-break:break-word; background: rgba(0,0,0,0.16); border:1px solid var(--border); border-radius:12px; padding:10px; }
.banner{ display:none; margin:10px 0 0; padding:10px; border-radius:12px; border:1px solid var(--border); background: rgba(239,68,68,0.12); color: #fecaca; }
.banner.show{ display:block; }
hr{ border:0; border-top:1px solid var(--border); margin:14px 0; }
.footer{ color:var(--muted); margin-top:14px; }
</style>
</head>
<body data-theme="dark" data-accent="purple">
<div class="wrap">
  <h1>LVN HESI Compass Practice</h1>
  <p class="sub">Hard-mode NGN practice • Topics aligned to your original Compass breakdown</p>

  <div class="grid">
    <div class="card">
      <div class="row">
        <div><label>Topic</label><select id="topic"></select></div>
        <div><label>Type</label>
          <select id="qtype">
            <option value="any">Any</option>
            <option value="single">Regular</option>
            <option value="sata">SATA</option>
            <option value="bowtie">Bowtie</option>
          </select>
        </div>
        <div><label>Level</label>
          <select id="level">
            <option value="any">Any</option>
            <option value="LVN">LVN</option>
            <option value="RN-very-hard">RN-very-hard</option>
          </select>
        </div>
        <div><label>Theme</label>
          <select id="theme">
            <option value="dark">Dark</option>
            <option value="light">Light</option>
            <option value="clinical">Clinical</option>
          </select>
        </div>
        <div><label>Accent</label>
          <select id="accent">
            <option value="purple">Purple</option>
            <option value="teal">Teal</option>
            <option value="rose">Rose</option>
            <option value="amber">Amber</option>
          </select>
        </div>

        <div class="btns">
          <button id="btnNext">Next Practice</button>
          <button class="secondary" id="btnExam">Start 75Q Exam</button>
          <button class="danger" id="btnReset">Reset</button>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="pill"><b id="count">0</b><span class="muted">questions loaded</span></div>
        <div class="pill"><span class="muted">Mode:</span><b id="mode">Practice</b></div>
        <div class="pill"><span class="muted">Score:</span><b id="score">0/0</b></div>
      </div>

      <div id="err" class="banner"></div>

      <hr>
      <div id="qArea"><p class="muted">Loading questions…</p></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">Case Tabs</h3>
      <div class="tabs" id="tabs"></div>
      <div id="tabBody" class="muted">Load a case-based question to view tabs.</div>
    </div>
  </div>

  <div class="footer">Deploy tip: upload this folder’s files to the same GitHub Pages directory. No service-worker caching.</div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const state = { QUESTIONS:[], pool:[], current:null, mode:"Practice", sel:null, answered:false, score:{correct:0,total:0} };

  function banner(msg){
    const el = $("err");
    el.textContent = msg || "";
    el.classList.toggle("show", !!msg);
  }

  async function fetchJson(url){
    const resp = await fetch(url, {cache:"no-store"});
    if(!resp.ok){
      const txt = await resp.text();
      throw new Error(`Fetch failed ${resp.status} ${resp.statusText} for ${url}. First: ${txt.slice(0,120)}`);
    }
    return await resp.json();
  }

  async function loadQuestions(){
    const base = new URL("./", window.location.href);
    const manifestUrl = new URL("questions_manifest.json", base).toString();
    const man = await fetchJson(manifestUrl);
    const arr = [];
    for(const p of man.parts){
      const data = await fetchJson(new URL(p, base).toString());
      if(Array.isArray(data)) arr.push(...data);
      else if(data && Array.isArray(data.questions)) arr.push(...data.questions);
    }
    return arr;
  }

  function normTopic(t){ return (t && String(t).trim()) ? String(t).trim() : "General"; }

  function rebuildTopicList(){
    const topics = Array.from(new Set(state.QUESTIONS.map(q => normTopic(q.topic)))).sort();
    const sel = $("topic");
    sel.innerHTML = "";
    sel.appendChild(new Option("Any","any"));
    topics.forEach(t => sel.appendChild(new Option(t,t)));
  }

  function applyTheme(){
    document.body.dataset.theme = $("theme").value;
    document.body.dataset.accent = $("accent").value;
  }

  function buildPool(){
    const t = $("topic").value, qt = $("qtype").value, lvl = $("level").value;
    state.pool = state.QUESTIONS.filter(q => {
      const okTopic = (t==="any" || normTopic(q.topic)===t);
      const okType = (qt==="any" || (q.qtype||q.type)===qt);
      const okLvl = (lvl==="any" || (q.level||"LVN")===lvl);
      return okTopic && okType && okLvl;
    });
    banner(state.pool.length ? "" : "No questions match this filter. Try Topic=Any, Type=Any, Level=Any.");
  }

  function pickOne(){ return state.pool.length ? state.pool[Math.floor(Math.random()*state.pool.length)] : null; }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function setTabs(q){
    const tabs = $("tabs"); tabs.innerHTML="";
    const hasCase = q && q.case;
    const items = hasCase ? [
      ["Case", q.case.case || q.case.summary || "—"],
      ["Vitals", JSON.stringify(q.case.vitals||[], null, 2)],
      ["Nurse Did", (q.case.nurse||[]).join("\n") || "—"],
      ["Provider Orders", (q.case.orders||[]).join("\n") || "—"],
      ["Rationale", q.rationale || "—"]
    ] : [["Info","No case tabs for this question."]];
    items.forEach(([name, body], idx) => {
      const b = document.createElement("div");
      b.className="tab"+(idx===0?" active":"");
      b.textContent=name;
      b.onclick=()=>{
        [...tabs.children].forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        $("tabBody").innerHTML = `<pre>${escapeHtml(String(body))}</pre>`;
      };
      tabs.appendChild(b);
      if(idx===0) $("tabBody").innerHTML = `<pre>${escapeHtml(String(body))}</pre>`;
    });
  }

  function showRationale(q){
    $("rat").innerHTML = `<pre>${escapeHtml(q.rationale || "—")}</pre>`;
  }

  function markScore(ok){
    state.score.total += 1;
    if(ok) state.score.correct += 1;
    $("score").textContent = `${state.score.correct}/${state.score.total}`;
  }

  function paintSingle(ans, sel){
    [...document.querySelectorAll(".choice")].forEach(n=>{
      const t=n.textContent;
      if(t===ans) n.classList.add("correct");
      if(sel && t===sel && sel!==ans) n.classList.add("wrong");
    });
  }

  function paintSATA(sel, correct){
    [...document.querySelectorAll(".choice")].forEach(n=>{
      const t=n.textContent;
      if(correct.includes(t)) n.classList.add("correct");
      if(sel.includes(t) && !correct.includes(t)) n.classList.add("wrong");
    });
  }

  function gradeStandard(q){
    if(state.answered) return;
    const qtype=q.qtype||q.type||"single";
    const ans=q.answer;
    if(qtype==="sata"){
      const sel = Array.isArray(state.sel) ? state.sel : [];
      const correct = Array.isArray(ans) ? ans : [];
      const right = sel.filter(x=>correct.includes(x)).length;
      const wrong = sel.filter(x=>!correct.includes(x)).length;
      const denom = Math.max(correct.length,1);
      const score = Math.max(0, Math.min(1, (right - wrong*0.5)/denom));
      const ok = score >= 0.80;
      state.answered=true;
      paintSATA(sel, correct);
      markScore(ok);
      $("rat").innerHTML = `<pre>${escapeHtml(q.rationale || "—")}\n\nNGN SATA Score: ${(score*100).toFixed(0)}% (>=80% counts correct)</pre>`;
      return;
    }else{
      const ok = (state.sel === ans);
      state.answered=true;
      paintSingle(ans, state.sel);
      markScore(ok);
      showRationale(q);
    }
  }

  function gradeBowtie(q){
    if(state.answered) return;
    const b=q.bowtie;
    const left=$("bow_left").value, mid=$("bow_middle").value, right=$("bow_right").value;
    const ok=(left===b.left_answer && mid===b.middle_answer && right===b.right_answer);
    state.answered=true;
    markScore(ok);
    showRationale(q);
  }

  function renderBowCol(side, label, options){
    return `<div style="flex:1; min-width:190px;">
      <label>${escapeHtml(label || side)}</label>
      <select id="bow_${side}" style="width:100%;">
        ${(options||[]).map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join("")}
      </select>
    </div>`;
  }

  function renderQuestion(q){
    state.current=q; state.answered=false; state.sel=null;
    const area=$("qArea");
    if(!q){ area.innerHTML=`<p class="muted">No question available.</p>`; return; }

    const qtype=q.qtype||q.type||"single";
    const stem=q.stem||q.question||"—";
    const choices=q.choices||q.options||[];
    const polarity=q.polarity||"positive";
    const lvl=q.level||"LVN";

    let html = `<div class="metaLine">
      <span class="tag">${escapeHtml(normTopic(q.topic))}</span>
      <span class="tag">${escapeHtml(qtype.toUpperCase())}</span>
      <span class="tag">${escapeHtml(lvl)}</span>
      <span class="tag">${escapeHtml(polarity)}</span>
    </div>
    <div class="qstem">${escapeHtml(stem)}</div>`;

    if(qtype==="bowtie" && q.bowtie){
      const b=q.bowtie;
      html += `<div class="muted">Bowtie: pick one in each column.</div>
      <div class="row" style="align-items:flex-start; gap:10px; margin-top:10px;">
        ${renderBowCol("left", b.left_label, b.left_options)}
        ${renderBowCol("middle", b.middle_label, b.middle_options)}
        ${renderBowCol("right", b.right_label, b.right_options)}
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="btnSubmit">Submit</button>
        <button class="secondary" id="btnShowRat">Rationale</button>
      </div>
      <div id="rat" style="margin-top:10px;"></div>`;
      area.innerHTML=html;
      $("btnSubmit").onclick=()=>gradeBowtie(q);
      $("btnShowRat").onclick=()=>showRationale(q);
      setTabs(q);
      return;
    }

    html += `<div class="choices" id="choices"></div>
      <div class="row" style="margin-top:10px;">
        <button id="btnSubmit">Submit</button>
        <button class="secondary" id="btnShowRat">Rationale</button>
      </div>
      <div id="rat" style="margin-top:10px;"></div>`;
    area.innerHTML=html;

    const c=$("choices");
    choices.forEach((ch)=>{
      const d=document.createElement("div");
      d.className="choice";
      d.textContent=ch;
      d.onclick=()=>{
        if(state.answered) return;
        if(qtype==="sata"){
          if(!Array.isArray(state.sel)) state.sel=[];
          if(state.sel.includes(ch)) state.sel = state.sel.filter(x=>x!==ch);
          else state.sel=[...state.sel, ch];
          d.classList.toggle("sel");
        }else{
          [...c.children].forEach(x=>x.classList.remove("sel"));
          state.sel=ch;
          d.classList.add("sel");
        }
      };
      c.appendChild(d);
    });

    $("btnSubmit").onclick=()=>gradeStandard(q);
    $("btnShowRat").onclick=()=>showRationale(q);
    setTabs(q);
  }

  function nextPractice(){
    state.mode="Practice"; $("mode").textContent=state.mode;
    buildPool(); renderQuestion(pickOne());
  }

  function startExam(){
    state.mode="Exam"; $("mode").textContent=state.mode;
    state.score={correct:0,total:0}; $("score").textContent="0/0";
    buildPool();
    const pool=[...state.pool];
    for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }
    const exam=pool.slice(0,75);
    renderQuestion(exam[0]||null);
  }

  function resetAll(){
    state.score={correct:0,total:0}; $("score").textContent="0/0";
    banner("");
    $("qArea").innerHTML=`<p class="muted">Reset complete. Click Next Practice.</p>`;
    $("tabBody").textContent="—"; $("tabs").innerHTML="";
  }

  function wireUI(){
    $("theme").onchange=applyTheme;
    $("accent").onchange=applyTheme;
    ["topic","qtype","level"].forEach(id=> $(id).onchange=()=>buildPool() );
    $("btnNext").onclick=nextPractice;
    $("btnExam").onclick=startExam;
    $("btnReset").onclick=resetAll;
    applyTheme();
  }

  (async function boot(){
    try{
      wireUI();
      const qs = await loadQuestions();
      state.QUESTIONS = qs;
      $("count").textContent=state.QUESTIONS.length;
      rebuildTopicList();
      buildPool();
      $("qArea").innerHTML=`<p class="muted">Loaded ${state.QUESTIONS.length} questions. Click Next Practice.</p>`;
    }catch(e){
      console.error(e);
      banner("Load failed: "+e.message);
      $("qArea").innerHTML=`<p class="muted">Could not load questions. Verify questions_manifest.json exists in the same folder.</p>`;
    }
  })();
})();
</script>
</body>
</html>