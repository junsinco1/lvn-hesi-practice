<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LVN HESI Practice</title>
<link rel="manifest" href="./manifest.json">
<style>
:root{
  --bg:#0b0f14; --panel:#111827; --panel2:#0f172a;
  --text:#e5e7eb; --muted:#9ca3af; --border:rgba(255,255,255,0.10);
  --radius:18px; --font: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  --accent:#4f46e5; --accent2:#22c55e;
  --accentSoft: rgba(79,70,229,0.18); --accentSoft2: rgba(79,70,229,0.10);
  --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
  --focus: 0 0 0 3px var(--accentSoft);
}
body[data-theme="dark"]{
  --bg:#0b0f14; --panel:#0f172a; --panel2:#111827; --text:#e5e7eb; --muted:#9ca3af; --border:rgba(255,255,255,0.10);
}
body[data-theme="light"]{
  --bg:#f6f7fb; --panel:#ffffff; --panel2:#ffffff; --text:#111827; --muted:#4b5563; --border:rgba(17,24,39,0.12);
  --accentSoft: rgba(79,70,229,0.14); --accentSoft2: rgba(79,70,229,0.08);
}
body[data-theme="midnight"]{
  --bg:#050814; --panel:#0a1026; --panel2:#0b1533; --text:#e7e9ff; --muted:#a6ace6; --border:rgba(231,233,255,0.14);
}
body[data-theme="clinical"]{
  --bg:#07121a; --panel:#0b1e2a; --panel2:#08202a; --text:#e6f6ff; --muted:#8fb0c3; --border:rgba(230,246,255,0.14);
}
body[data-theme="sand"]{
  --bg:#fbf6ef; --panel:#ffffff; --panel2:#ffffff; --text:#1f2937; --muted:#6b7280; --border:rgba(31,41,55,0.12);
  --accentSoft: rgba(245,158,11,0.14); --accentSoft2: rgba(245,158,11,0.08);
}
body[data-accent="indigo"]{ --accent:#4f46e5; --accentSoft: rgba(79,70,229,0.18); --accentSoft2: rgba(79,70,229,0.10); }
body[data-accent="purple"]{ --accent:#7c3aed; --accentSoft: rgba(124,58,237,0.18); --accentSoft2: rgba(124,58,237,0.10); }
body[data-accent="teal"]{ --accent:#06b6d4; --accentSoft: rgba(6,182,212,0.18); --accentSoft2: rgba(6,182,212,0.10); }
body[data-accent="emerald"]{ --accent:#10b981; --accentSoft: rgba(16,185,129,0.18); --accentSoft2: rgba(16,185,129,0.10); }
body[data-accent="rose"]{ --accent:#f43f5e; --accentSoft: rgba(244,63,94,0.18); --accentSoft2: rgba(244,63,94,0.10); }
body[data-accent="amber"]{ --accent:#f59e0b; --accentSoft: rgba(245,158,11,0.20); --accentSoft2: rgba(245,158,11,0.10); }
body[data-accent="sky"]{ --accent:#0ea5e9; --accentSoft: rgba(14,165,233,0.18); --accentSoft2: rgba(14,165,233,0.10); }

*{ box-sizing:border-box; }
body{
  margin:0; font-family:var(--font);
  background:
    radial-gradient(900px 600px at 12% 0%, var(--accentSoft2), transparent 55%),
    radial-gradient(700px 500px at 100% 10%, rgba(34,197,94,0.06), transparent 55%),
    radial-gradient(900px 700px at 40% 120%, rgba(14,165,233,0.06), transparent 60%),
    var(--bg);
  color:var(--text);
}
.wrap{ max-width:1220px; margin:0 auto; padding:18px; }
h1{ font-size:26px; margin:0 0 6px; letter-spacing:0.2px; }
.sub{ color:var(--muted); margin:0 0 16px; }
.grid{ display:grid; grid-template-columns: 1.38fr 0.62fr; gap:14px; }
@media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }
.card{
  background:
    linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)),
    radial-gradient(600px 200px at 25% 0%, var(--accentSoft2), transparent 55%),
    var(--panel);
  border:1px solid var(--border); border-radius:var(--radius); padding:14px;
  box-shadow: 0 18px 46px rgba(0,0,0,0.22);
  position:relative; overflow:hidden;
}
.row{ display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; }
label{ font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }
select, input{
  background: rgba(0,0,0,0.10); color:var(--text);
  border:1px solid var(--border); border-radius:12px; padding:10px 10px;
  min-width:150px; outline:none;
}
select:focus, input:focus{ box-shadow: var(--focus); border-color: var(--accent); }
.btns{ margin-left:auto; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
button{
  background: linear-gradient(180deg, rgba(255,255,255,0.20), rgba(255,255,255,0.04)), var(--accent);
  color:white; border:0; border-radius:12px; padding:10px 14px; font-weight:850;
  cursor:pointer; box-shadow: 0 10px 22px rgba(0,0,0,0.22);
}
button:hover{ filter:brightness(1.05); }
button:focus{ outline:none; box-shadow: var(--focus); }
button.secondary{ background: rgba(0,0,0,0.12); border:1px solid var(--border); color:var(--text); box-shadow:none; }
button.danger{ background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.04)), var(--bad); }
.pill{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 10px; border:1px solid var(--border); border-radius:999px;
  color:var(--muted); background: rgba(0,0,0,0.10);
}
.pill b{ color:var(--text); }
.tag{ font-size:12px; color:var(--text); background: var(--accentSoft); border:1px solid rgba(255,255,255,0.06);
  padding:6px 10px; border-radius:999px; }
.metaLine{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
.qstem{ font-size:18px; line-height:1.35; margin:0 0 10px; }
.choices{ display:grid; gap:8px; }
.choice{
  border:1px solid var(--border); border-radius:14px; padding:10px 12px; cursor:pointer;
  background: rgba(0,0,0,0.08); transition: transform 0.04s ease, border-color 0.12s ease, background 0.12s ease;
}
.choice:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,0.18); }
.choice.sel{ box-shadow: var(--focus); border-color: var(--accent); background: var(--accentSoft2); }
.choice.correct{ border-color: rgba(34,197,94,0.7); box-shadow: 0 0 0 3px rgba(34,197,94,0.18); }
.choice.wrong{ border-color: rgba(239,68,68,0.7); box-shadow: 0 0 0 3px rgba(239,68,68,0.18); }
.tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
.tab{ padding:8px 10px; border-radius:10px; border:1px solid var(--border); color:var(--muted); cursor:pointer; background: rgba(0,0,0,0.08); }
.tab.active{ color:var(--text); border-color: var(--accent); box-shadow: var(--focus); background: var(--accentSoft2); }
pre{ white-space:pre-wrap; word-break:break-word; background: rgba(0,0,0,0.16); border:1px solid var(--border); border-radius:14px; padding:10px; }
.banner{ display:none; margin:10px 0 0; padding:10px; border-radius:12px; border:1px solid var(--border); background: rgba(239,68,68,0.12); color: #fecaca; }
.banner.show{ display:block; }
hr{ border:0; border-top:1px solid var(--border); margin:14px 0; }
.footer{ color:var(--muted); margin-top:14px; }
.small{ font-size:12px; color:var(--muted); }
.kpi{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
.kpi .card2{ padding:10px; border:1px solid var(--border); border-radius:14px; background: rgba(0,0,0,0.10); }
.kpi .card2 b{ font-size:18px; }
.table{ width:100%; border-collapse:collapse; }
.table th,.table td{ padding:8px; border-bottom:1px solid var(--border); text-align:left; font-size:13px; }
.table th{ color:var(--muted); font-weight:700; }
.timer{ font-variant-numeric: tabular-nums; }
.progressWrap{ height:10px; background: rgba(255,255,255,0.08); border-radius:999px; overflow:hidden; border:1px solid var(--border); }
.progress{ height:100%; width:0%; background: linear-gradient(90deg, var(--accent), rgba(34,197,94,0.8)); }
</style>
</head>
<body data-theme="dark" data-accent="indigo">
<div class="wrap">
  <h1>LVN HESI Compass Practice</h1>
  <p class="sub">Hard-mode NGN practice • A&P • Micro • Pharm • ADPIE • Math conversions • Timer • XP • Leaderboard</p>

  <div class="grid">
    <div class="card">
      <div class="row">
        <div><label>Topic</label><select id="topic"></select></div>
        <div><label>Type</label>
          <select id="qtype">
            <option value="any">Any</option>
            <option value="single">Regular</option>
            <option value="sata">SATA</option>
            <option value="bowtie">Bowtie</option>
          </select>
        </div>
        <div><label>Level</label>
          <select id="level">
            <option value="any">Any</option>
            <option value="LVN">LVN</option>
            <option value="RN-very-hard">RN-very-hard</option>
          </select>
        </div>
        <div><label>Timer / question</label>
          <select id="timerSel">
            <option value="0">Off</option>
            <option value="30">30s</option>
            <option value="45">45s</option>
            <option value="60">60s</option>
            <option value="90">90s</option>
            <option value="120">120s</option>
          </select>
        </div>
        <div><label>Theme</label>
          <select id="theme">
            <option value="dark">Dark</option>
            <option value="midnight">Midnight</option>
            <option value="clinical">Clinical</option>
            <option value="light">Light</option>
            <option value="sand">Sand</option>
          </select>
        </div>
        <div><label>Accent</label>
          <select id="accent">
            <option value="indigo">Indigo</option>
            <option value="purple">Purple</option>
            <option value="sky">Sky</option>
            <option value="teal">Teal</option>
            <option value="emerald">Emerald</option>
            <option value="rose">Rose</option>
            <option value="amber">Amber</option>
          </select>
        </div>

        <div class="btns">
          <button id="btnNext">Next Practice</button>
          <button class="secondary" id="btnExam">Start 75Q Exam</button>
          <button class="secondary" id="btnLeaderboard">Leaderboard</button>
          <button class="danger" id="btnReset">Reset</button>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="pill"><b id="count">0</b><span class="muted">loaded</span></div>
        <div class="pill"><span class="muted">Mode:</span><b id="mode">Practice</b></div>
        <div class="pill"><span class="muted">Score:</span><b id="score">0/0</b></div>
        <div class="pill"><span class="muted">XP:</span><b id="xp">0</b></div>
        <div class="pill"><span class="muted">Streak:</span><b id="streak">0</b></div>
        <div class="pill"><span class="muted">Timer:</span><b class="timer" id="timer">--</b></div>
      </div>

      <div class="progressWrap" style="margin-top:10px;"><div class="progress" id="progress"></div></div>

      <div id="err" class="banner"></div>

      <hr>
      <div id="qArea"><p class="muted">Loading questions…</p></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">Case Tabs</h3>
      <div class="tabs" id="tabs"></div>
      <div id="tabBody" class="muted">Load a case-based question to view tabs.</div>
      <hr>
      <h3 style="margin:0 0 8px;">Gamification</h3>
      <div class="kpi">
        <div class="card2"><div class="small">Rank</div><b id="rank">Novice</b></div>
        <div class="card2"><div class="small">Accuracy</div><b id="acc">--</b></div>
      </div>
      <div class="small" style="margin-top:10px;">Finish a 75Q exam to save to the leaderboard.</div>
      <div id="panel" style="margin-top:10px;"></div>
    </div>
  </div>

  <div class="footer">Deploy: upload this folder’s files to GitHub Pages. No service-worker caching.</div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const LS = { xp:"lvn_xp_v1", streak:"lvn_streak_v1", mastery:"lvn_mastery_v1", leaderboard:"lvn_leaderboard_v1", settings:"lvn_settings_v2" };
  const state = { QUESTIONS:[], pool:[], current:null, mode:"Practice", sel:null, answered:false,
    score:{correct:0,total:0}, exam:{active:false, idx:0, items:[], startedAt:0}, timer:{sec:0,left:0,handle:null}, xp:0, streak:0, mastery:{} };

  function banner(msg){ const el=$("err"); el.textContent=msg||""; el.classList.toggle("show",!!msg); }
  function safeJsonParse(s,fallback){ try{ return JSON.parse(s);}catch(e){ return fallback; } }

  function loadLocal(){
    state.xp=Number(localStorage.getItem(LS.xp)||0);
    state.streak=Number(localStorage.getItem(LS.streak)||0);
    state.mastery=safeJsonParse(localStorage.getItem(LS.mastery)||"{}",{});
    const settings=safeJsonParse(localStorage.getItem(LS.settings)||"{}",{});
    if(settings.theme) $("theme").value=settings.theme;
    if(settings.accent) $("accent").value=settings.accent;
    if(settings.timer!=null) $("timerSel").value=String(settings.timer);
  }
  function saveLocal(){
    localStorage.setItem(LS.xp,String(state.xp));
    localStorage.setItem(LS.streak,String(state.streak));
    localStorage.setItem(LS.mastery,JSON.stringify(state.mastery||{}));
    localStorage.setItem(LS.settings,JSON.stringify({theme:$("theme").value,accent:$("accent").value,timer:Number($("timerSel").value||0)}));
  }

  function rankFromXP(xp){
    const tiers=[[0,"Novice"],[250,"Apprentice"],[650,"Competent"],[1300,"Proficient"],[2400,"Advanced"],[3800,"Expert"],[5600,"Clinical Ace"]];
    let r=tiers[0][1]; for(const [min,name] of tiers){ if(xp>=min) r=name; } return r;
  }
  function updateHUD(){
    $("mode").textContent = state.mode + (state.exam.active ? ` (${state.exam.idx+1}/${state.exam.items.length})` : "");
    $("score").textContent = `${state.score.correct}/${state.score.total}`;
    $("xp").textContent=String(state.xp);
    $("streak").textContent=String(state.streak);
    $("rank").textContent=rankFromXP(state.xp);
    const acc=state.score.total?Math.round((state.score.correct/state.score.total)*100):null;
    $("acc").textContent=acc==null?"--":(acc+"%");
    $("progress").style.width=state.exam.active?`${Math.round(((state.exam.idx)/Math.max(1,state.exam.items.length))*100)}%`:"0%";
  }

  async function fetchJson(url){
    const resp=await fetch(url,{cache:"no-store"});
    if(!resp.ok){ const txt=await resp.text(); throw new Error(`Fetch failed ${resp.status} for ${url}. First: ${txt.slice(0,120)}`); }
    return await resp.json();
  }
  async function loadQuestions(){
    const base=new URL("./",window.location.href);
    const man=await fetchJson(new URL("questions_manifest.json",base).toString());
    const arr=[];
    for(const p of man.parts){
      const data=await fetchJson(new URL(p,base).toString());
      if(Array.isArray(data)) arr.push(...data);
      else if(data && Array.isArray(data.questions)) arr.push(...data.questions);
    }
    return arr;
  }
  function normTopic(t){ return (t && String(t).trim()) ? String(t).trim() : "General"; }
  function rebuildTopicList(){
    const topics=Array.from(new Set(state.QUESTIONS.map(q=>normTopic(q.topic)))).sort();
    const sel=$("topic"); sel.innerHTML=""; sel.appendChild(new Option("Any","any"));
    topics.forEach(t=>sel.appendChild(new Option(t,t)));
  }
  function applyTheme(){ document.body.dataset.theme=$("theme").value; document.body.dataset.accent=$("accent").value; saveLocal(); }
  function buildPool(){
    const t=$("topic").value, qt=$("qtype").value, lvl=$("level").value;
    state.pool=state.QUESTIONS.filter(q=>{
      const okT=(t==="any"||normTopic(q.topic)===t);
      const okTy=(qt==="any"||(q.qtype||q.type)===qt);
      const okL=(lvl==="any"||(q.level||"LVN")===lvl);
      return okT&&okTy&&okL;
    });
    banner(state.pool.length?"":"No questions match this filter. Try Any.");
  }
  function pickOne(){ return state.pool.length?state.pool[Math.floor(Math.random()*state.pool.length)]:null; }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function setTabs(q){
    const tabs=$("tabs"); tabs.innerHTML="";
    const hasCase=q && q.case;
    const items=hasCase ? [
      ["Case", q.case.case || q.case.summary || "—"],
      ["Vitals", JSON.stringify(q.case.vitals||[], null, 2)],
      ["Labs", JSON.stringify(q.case.labs||{}, null, 2)],
      ["Nurse Did", (q.case.nurse||[]).join("
")||"—"],
      ["Provider Orders", (q.case.orders||[]).join("
")||"—"],
      ["Rationale", q.rationale||"—"]
    ] : [["Info","No case tabs for this question."]];
    items.forEach(([name,body],idx)=>{
      const b=document.createElement("div"); b.className="tab"+(idx===0?" active":""); b.textContent=name;
      b.onclick=()=>{ [...tabs.children].forEach(x=>x.classList.remove("active")); b.classList.add("active"); $("tabBody").innerHTML=`<pre>${escapeHtml(String(body))}</pre>`; };
      tabs.appendChild(b); if(idx===0) $("tabBody").innerHTML=`<pre>${escapeHtml(String(body))}</pre>`;
    });
  }

  // Timer
  function stopTimer(){ if(state.timer.handle){ clearInterval(state.timer.handle); state.timer.handle=null; } }
  function setTimerDisplay(){
    $("timer").textContent = state.timer.sec ? `${state.timer.left}s` : "--";
    $("timer").style.color = (state.timer.sec && state.timer.left<=10) ? "var(--warn)" : "";
  }
  function startTimer(){
    stopTimer();
    state.timer.sec=Number($("timerSel").value||0);
    state.timer.left=state.timer.sec;
    saveLocal();
    setTimerDisplay();
    if(!state.timer.sec) return;
    state.timer.handle=setInterval(()=>{
      if(state.answered){ stopTimer(); setTimerDisplay(); return; }
      state.timer.left -= 1; setTimerDisplay();
      if(state.timer.left<=0){
        stopTimer();
        if(!state.answered){ banner("Time's up! Auto-submitted."); gradeCurrent(true); }
      }
    },1000);
  }

  function awardXP(q, wasCorrect){
    const lvl=(q.level||"LVN");
    const base=(lvl==="RN-very-hard")?20:12;
    const streakBonus=(wasCorrect && state.streak>=3)?Math.min(10,state.streak):0;
    state.xp += wasCorrect ? (base+streakBonus) : 2;
  }
  function updateMastery(q, wasCorrect){
    const t=normTopic(q.topic);
    const m=state.mastery||{};
    const cur=m[t]||{seen:0,correct:0};
    cur.seen+=1; if(wasCorrect) cur.correct+=1;
    m[t]=cur; state.mastery=m;
  }
  function markScore(wasCorrect){ state.score.total+=1; if(wasCorrect) state.score.correct+=1; }

  function paintSingle(ans, sel){
    [...document.querySelectorAll(".choice")].forEach(n=>{
      const t=n.textContent;
      if(t===ans) n.classList.add("correct");
      if(sel && t===sel && sel!==ans) n.classList.add("wrong");
    });
  }
  function paintSATA(sel, correct){
    [...document.querySelectorAll(".choice")].forEach(n=>{
      const t=n.textContent;
      if(correct.includes(t)) n.classList.add("correct");
      if(sel.includes(t) && !correct.includes(t)) n.classList.add("wrong");
    });
  }
  function showRationale(q, extra){
    const el=$("rat");
    el.innerHTML=`<pre>${escapeHtml(q.rationale||"—")}${extra?("\n\n"+escapeHtml(extra)):""}</pre>`;
  }

  function gradeCurrent(timedOut=false){
    const q=state.current;
    if(!q || state.answered) return;
    const qtype=q.qtype||q.type||"single";
    const ans=q.answer;
    let wasCorrect=false;
    let extra="";
    if(qtype==="sata"){
      const sel=Array.isArray(state.sel)?state.sel:[];
      const correct=Array.isArray(ans)?ans:[];
      const right=sel.filter(x=>correct.includes(x)).length;
      const wrong=sel.filter(x=>!correct.includes(x)).length;
      const denom=Math.max(correct.length,1);
      const score=Math.max(0,Math.min(1,(right-wrong*0.5)/denom));
      wasCorrect=score>=0.80;
      state.answered=true;
      paintSATA(sel,correct);
      extra=`NGN SATA Score: ${(score*100).toFixed(0)}% (>=80% counts correct)`;
    }else if(qtype==="bowtie" && q.bowtie){
      const b=q.bowtie;
      const left=$("bow_left").value, mid=$("bow_middle").value, right=$("bow_right").value;
      if(!left||!mid||!right){ banner("Select an option in all three bowtie columns before submitting."); return; }
      wasCorrect=(left===b.left_answer && mid===b.middle_answer && right===b.right_answer);
      state.answered=true;
      extra=`Correct: ${b.left_answer} | ${b.middle_answer} | ${b.right_answer}`;
    }else{
      wasCorrect=(state.sel===ans);
      state.answered=true;
      paintSingle(ans,state.sel);
    }

    if(wasCorrect) state.streak += 1; else state.streak = 0;
    awardXP(q,wasCorrect);
    updateMastery(q,wasCorrect);
    markScore(wasCorrect);
    saveLocal();
    stopTimer();
    updateHUD();
    showRationale(q, (timedOut?("Timed out. "):"") + extra);
    renderAfterSubmitControls();
  }

  function renderAfterSubmitControls(){
    const actions=$("afterActions");
    if(!actions) return;
    actions.innerHTML="";
    if(state.exam.active){
      const btn=document.createElement("button");
      btn.textContent=(state.exam.idx<state.exam.items.length-1)?"Next Question":"Finish Exam";
      btn.onclick=()=>advanceExam();
      actions.appendChild(btn);
    }else{
      const btn=document.createElement("button");
      btn.textContent="Next Practice";
      btn.onclick=()=>nextPractice();
      actions.appendChild(btn);
    }
    const btn2=document.createElement("button");
    btn2.textContent="Leaderboard";
    btn2.className="secondary";
    btn2.onclick=()=>showLeaderboard();
    actions.appendChild(btn2);
  }

  function renderBowCol(side,label,options){
    return `<div style="flex:1; min-width:190px;">
      <label>${escapeHtml(label||side)}</label>
      <select id="bow_${side}" style="width:100%;">
        <option value="">-- select --</option>
        ${(options||[]).map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join("")}
      </select>
    </div>`;
  }

  function renderQuestion(q){
    state.current=q; state.answered=false; state.sel=null; banner("");
    const area=$("qArea");
    if(!q){ area.innerHTML=`<p class="muted">No question available.</p>`; return; }

    const qtype=q.qtype||q.type||"single";
    const stem=q.stem||q.question||"—";
    const caseObj = q.case || null;
    const choices=q.choices||q.options||[];
    const polarity=q.polarity||"positive";
    const lvl=q.level||"LVN";

    let html=`<div class="metaLine">
      <span class="tag">${escapeHtml(normTopic(q.topic))}</span>
      <span class="tag">${escapeHtml(qtype.toUpperCase())}</span>
      <span class="tag">${escapeHtml(lvl)}</span>
      <span class="tag">${escapeHtml(polarity)}</span>
    </div>
    <div id="caseBanner" class="small" style="margin:6px 0 10px; padding:10px; border:1px solid var(--border); border-radius:14px; background: rgba(0,0,0,0.10);"></div><div class="qstem">${escapeHtml(stem)}</div>`;

    if(qtype==="bowtie" && q.bowtie){
      const b=q.bowtie;
      html+=`<div class="small">Bowtie: pick one in each column.</div>
      <div class="row" style="align-items:flex-start; gap:10px; margin-top:10px;">
        ${renderBowCol("left",b.left_label,b.left_options)}
        ${renderBowCol("middle",b.middle_label,b.middle_options)}
        ${renderBowCol("right",b.right_label,b.right_options)}
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="btnSubmit">Submit</button>
        <button class="secondary" id="btnShowRat">Rationale</button>
      </div>
      <div id="rat" style="margin-top:10px;"></div>
      <div class="row" id="afterActions" style="margin-top:10px;"></div>`;
      area.innerHTML=html;
      // Case banner
      try{
        const cb=document.getElementById("caseBanner");
        if(cb){
          if(caseObj){
            const s=(caseObj.setting?("Setting: "+caseObj.setting+". "):"")+(caseObj.history?caseObj.history+" ":"");
            cb.textContent=s.trim() || "Case details available in tabs.";
          }else{
            cb.textContent="";
          }
        }
      }catch(e){}
      $("btnSubmit").onclick=()=>gradeCurrent(false);
      $("btnShowRat").onclick=()=>showRationale(q);
      setTabs(q); updateHUD(); startTimer(); renderAfterSubmitControls();
      return;
    }

    html+=`<div class="choices" id="choices"></div>
    <div class="row" style="margin-top:10px;">
      <button id="btnSubmit">Submit</button>
      <button class="secondary" id="btnShowRat">Rationale</button>
    </div>
    <div id="rat" style="margin-top:10px;"></div>
    <div class="row" id="afterActions" style="margin-top:10px;"></div>`;
    area.innerHTML=html;
    // Case banner
    try{
      const cb=document.getElementById("caseBanner");
      if(cb){
        if(caseObj){
          const s=(caseObj.setting?("Setting: "+caseObj.setting+". "):"")+(caseObj.history?caseObj.history+" ":"");
          cb.textContent=s.trim() || "Case details available in tabs.";
        }else{
          cb.textContent="";
        }
      }
    }catch(e){}
    const c=$("choices");
    choices.forEach((ch)=>{
      const d=document.createElement("div");
      d.className="choice";
      d.textContent=ch;
      d.onclick=()=>{
        if(state.answered) return;
        if(qtype==="sata"){
          if(!Array.isArray(state.sel)) state.sel=[];
          if(state.sel.includes(ch)) state.sel=state.sel.filter(x=>x!==ch);
          else state.sel=[...state.sel,ch];
          d.classList.toggle("sel");
        }else{
          [...c.children].forEach(x=>x.classList.remove("sel"));
          state.sel=ch; d.classList.add("sel");
        }
      };
      c.appendChild(d);
    });
    $("btnSubmit").onclick=()=>gradeCurrent(false);
    $("btnShowRat").onclick=()=>showRationale(q);
    setTabs(q); updateHUD(); startTimer(); renderAfterSubmitControls();
  }

  function nextPractice(){
    state.exam.active=false; state.mode="Practice"; $("progress").style.width="0%";
    buildPool(); renderQuestion(pickOne());
  }

  function startExam(){
    state.mode="Exam"; state.score={correct:0,total:0};
    state.exam.active=true; state.exam.idx=0; state.exam.startedAt=Date.now();
    buildPool();
    const pool=[...state.pool];
    for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }
    state.exam.items=pool.slice(0,75);
    renderQuestion(state.exam.items[0]||null);
  }

  function advanceExam(){
    if(!state.exam.active) return;
    if(!state.answered){ banner("Submit the question first."); return; }
    if(state.exam.idx>=state.exam.items.length-1){ finishExam(); return; }
    state.exam.idx += 1; renderQuestion(state.exam.items[state.exam.idx]);
  }

  function finishExam(){
    stopTimer();
    const elapsed=Math.max(1,Math.round((Date.now()-state.exam.startedAt)/1000));
    const pct=Math.round((state.score.correct/Math.max(1,state.score.total))*100);
    const area=$("qArea");
    state.exam.active=false; state.mode="Exam Finished"; updateHUD();
    area.innerHTML=`
      <div class="metaLine">
        <span class="tag">Exam Complete</span>
        <span class="tag">${pct}%</span>
        <span class="tag">${state.score.correct}/${state.score.total}</span>
        <span class="tag">${elapsed}s</span>
      </div>
      <div class="qstem">Save your score to the leaderboard</div>
      <div class="row">
        <div><label>Initials (2–4)</label><input id="initials" maxlength="4" placeholder="PI" style="min-width:120px;"></div>
        <div class="btns" style="margin-left:0;">
          <button id="btnSave">Save</button>
          <button class="secondary" id="btnViewLB">View Leaderboard</button>
          <button class="secondary" id="btnNewExam">New 75Q Exam</button>
        </div>
      </div>
      <div id="rat" style="margin-top:10px;"></div>`;
    $("btnSave").onclick=()=>saveLeaderboard(elapsed,pct);
    $("btnViewLB").onclick=()=>showLeaderboard();
    $("btnNewExam").onclick=()=>startExam();
    showRationale({rationale:`Exam summary: ${pct}% (${state.score.correct}/${state.score.total}) in ${elapsed}s.\nXP continues to accumulate across sessions.`});
  }

  function getLeaderboard(){ return safeJsonParse(localStorage.getItem(LS.leaderboard)||"[]",[]); }
  function setLeaderboard(list){ localStorage.setItem(LS.leaderboard,JSON.stringify(list)); }
  function saveLeaderboard(elapsed,pct){
    const raw=(document.getElementById("initials")?.value||"").trim().toUpperCase();
    const initials=raw.replace(/[^A-Z0-9]/g,"").slice(0,4);
    if(initials.length<2){ banner("Enter 2–4 initials to save."); return; }
    const entry={initials,pct,correct:state.score.correct,total:state.score.total,seconds:elapsed,when:new Date().toISOString()};
    const lb=getLeaderboard(); lb.push(entry);
    lb.sort((a,b)=>(b.pct-a.pct)||(a.seconds-b.seconds));
    setLeaderboard(lb.slice(0,50));
    banner("Saved to leaderboard.");
    showLeaderboard();
  }

  function showLeaderboard(){
    const panel=$("panel");
    const lb=getLeaderboard();
    if(!lb.length){ panel.innerHTML=`<div class="small">No scores yet. Finish a 75Q exam and save with initials.</div>`; return; }
    const rows=lb.slice(0,15).map((e,idx)=>{
      const d=new Date(e.when); const date=isNaN(d.getTime())?"":d.toLocaleDateString();
      return `<tr><td>${idx+1}</td><td><b>${escapeHtml(e.initials)}</b></td><td>${e.pct}%</td><td>${e.correct}/${e.total}</td><td>${e.seconds}s</td><td class="small">${escapeHtml(date)}</td></tr>`;
    }).join("");
    panel.innerHTML=`<div class="metaLine"><span class="tag">Leaderboard</span><span class="tag">Top 15</span></div>
      <table class="table"><thead><tr><th>#</th><th>Initials</th><th>%</th><th>Score</th><th>Time</th><th>Date</th></tr></thead><tbody>${rows}</tbody></table>
      <div class="row" style="margin-top:10px;"><button class="secondary" id="btnClearLB">Clear Leaderboard</button></div>`;
    document.getElementById("btnClearLB").onclick=()=>{ if(confirm("Clear leaderboard?")){ setLeaderboard([]); showLeaderboard(); } };
  }

  function resetAll(){
    stopTimer();
    state.score={correct:0,total:0};
    state.exam={active:false,idx:0,items:[],startedAt:0};
    state.mode="Practice";
    banner("");
    $("qArea").innerHTML=`<p class="muted">Reset complete. Click Next Practice.</p>`;
    $("tabBody").textContent="—"; $("tabs").innerHTML="";
    updateHUD();
  }

  function wireUI(){
    loadLocal();
    $("theme").onchange=applyTheme;
    $("accent").onchange=applyTheme;
    $("timerSel").onchange=()=>{ saveLocal(); if(state.current) startTimer(); };
    ["topic","qtype","level"].forEach(id=>$(id).onchange=()=>buildPool());
    $("btnNext").onclick=nextPractice;
    $("btnExam").onclick=startExam;
    $("btnReset").onclick=resetAll;
    $("btnLeaderboard").onclick=showLeaderboard;
    applyTheme();
    updateHUD();
  }

  (async function boot(){
    try{
      wireUI();
      const qs=await loadQuestions();
      state.QUESTIONS=qs.map((q,idx)=>({...q,id:q.id||`q_${idx}`,topic:normTopic(q.topic),qtype:q.qtype||q.type||"single",choices:q.choices||q.options||[],level:q.level||"LVN"}));
      $("count").textContent=state.QUESTIONS.length;
      rebuildTopicList();
      buildPool();
      $("qArea").innerHTML=`<p class="muted">Loaded ${state.QUESTIONS.length} questions. Click Next Practice or Start 75Q Exam.</p>`;
      showLeaderboard();
    }catch(e){
      console.error(e);
      banner("Load failed: "+e.message);
      $("qArea").innerHTML=`<p class="muted">Could not load questions. Verify questions_manifest.json exists in the same folder.</p>`;
    }
  })();
})();
</script>
</body>
</html>
